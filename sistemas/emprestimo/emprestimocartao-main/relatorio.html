<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Relatório de Empréstimos</title>

<link rel="stylesheet" href="style.css">
<link rel="icon" href="favicon.ico">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* === estilos originais mantidos === */
.attention{margin-left:6px;animation:blink 1s infinite}
@keyframes blink{0%,50%,100%{opacity:1}25%,75%{opacity:0}}
.admin-delete{cursor:pointer;font-size:18px;color:#ff5555}
.admin-delete:hover{transform:scale(1.2)}
</style>
</head>

<body>

<header>
  <h1>Relatório de Empréstimos</h1>
  <button onclick="location.href='index.html'">🏠 Voltar</button>
</header>

<main>
  <aside id="estoque">
    <h2>📦 Estoque</h2>
    <div id="estoqueConteudo">Carregando...</div>
  </aside>

  <div class="table-wrap">
    <div id="controlsHolder"></div>

    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>Matrícula</th>
          <th>Tipo</th>
          <th>Digicon</th>
          <th>Prodata</th>
          <th>Meia</th>
          <th>Motivo</th>
          <th>Data</th>
          <th>Prazo</th>
          <th>Status</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="relatorioBody"></tbody>
    </table>
  </div>
</main>

<script src="firebaseConfig.js"></script>

<script>
/* ===== CONFIG ADMIN (mantido simples) ===== */
const isAdmin = true;

/* ===== CONTROLES ===== */
function criarControles(){
  const div=document.createElement('div');
  div.className='controls-bar';

  div.innerHTML=`
    <select id="statusFilter">
      <option value="todos">Todos</option>
      <option value="em aberto">Em aberto</option>
      <option value="resolvido">Resolvido</option>
    </select>

    <input id="cardNumberFilter" placeholder="Nº cartão">
    <input id="matriculaFilter" placeholder="Matrícula">
  `;

  document.getElementById('controlsHolder').appendChild(div);

  div.querySelectorAll('select,input')
    .forEach(el=>el.addEventListener('input',carregarRelatorio));
}

/* ===== RELATÓRIO ===== */
async function carregarRelatorio(){
  const tbody=document.getElementById('relatorioBody');
  tbody.innerHTML='';

  const statusFiltro=document.getElementById('statusFilter').value;
  const cardFiltro=document.getElementById('cardNumberFilter').value.trim();
  const matFiltro=document.getElementById('matriculaFilter').value.trim();

  const snap=await db.collection('emprestimos').orderBy('timestamp','desc').get();

  snap.forEach(doc=>{
    const d=doc.data();
    const tipo=(d.tipoCartao||'').toLowerCase();

    /* --- filtro status --- */
    if(statusFiltro!=='todos' && d.status!==statusFiltro) return;

    /* --- filtro cartão (CORRETO) --- */
    if(cardFiltro){
      if(tipo==='digicon' && d.numBordoDigicon?.toString()!==cardFiltro) return;
      if(tipo==='prodata' && d.numBordoProdata?.toString()!==cardFiltro) return;
      if(tipo==='meia' && d.numMeiaViagem?.toString()!==cardFiltro) return;
    }

    if(matFiltro && !(d.matricula||'').includes(matFiltro)) return;

    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${d.nomeMotorista||''}</td>
      <td>${d.matricula||''}${d.totalRetiradas>2?'<span class="attention">⚠️</span>':''}</td>
      <td>${d.tipoCartao||''}</td>
      <td>${d.numBordoDigicon||'-'}</td>
      <td>${d.numBordoProdata||'-'}</td>
      <td>${d.numMeiaViagem||'-'}</td>
      <td>${d.motivo||''}</td>
      <td>${d.dataRetirada||''}</td>
      <td>${d.prazoDevolucao||''}</td>
      <td>
        <button class="statusBtn"
          style="background:${d.status==='em aberto'?'#ff5555':'#55ff55'}">
          ${d.status}
        </button>
      </td>
      <td>
        ${isAdmin?'<span class="admin-delete">🗑️</span>':''}
      </td>
    `;

    /* status toggle */
    tr.querySelector('.statusBtn').onclick=async()=>{
      const novo=d.status==='em aberto'?'resolvido':'em aberto';
      await db.collection('emprestimos').doc(doc.id).update({status:novo});
      carregarRelatorio();
    };

    /* excluir */
    if(isAdmin){
      tr.querySelector('.admin-delete').onclick=async()=>{
        if(confirm('Excluir este empréstimo definitivamente?')){
          await db.collection('emprestimos').doc(doc.id).delete();
          carregarRelatorio();
        }
      };
    }

    tbody.appendChild(tr);
  });
}

/* ===== INIT ===== */
criarControles();
carregarRelatorio();
atualizarEstoque();
</script>

</body>
</html>
