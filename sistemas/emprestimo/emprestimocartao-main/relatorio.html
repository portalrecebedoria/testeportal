<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Relatório de Empréstimos</title>
<link rel="stylesheet" href="style.css">
<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { background-color: #121212; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #e0e0e0; margin:0; padding:20px;}
header { display:flex; align-items:center; gap:15px; margin-bottom:20px; }
header img.logo { height:50px; }
header h1 { flex-grow:1; font-size:1.5rem; color:#00ff7f; }
header button { padding:5px 10px; border-radius:5px; border:none; cursor:pointer; background:#00ff7f; color:#111; }

main { display:flex; gap:20px; align-items:flex-start; }
#estoque { width:320px; background:#1e1e1e; padding:15px; border-radius:10px; color:#e0e0e0; height:auto; max-height:600px; overflow-y:auto;}
#estoque h2 { color:#00ff7f; font-size:1.1rem; margin-bottom:10px;}
.cardEstoque { background:#2a2a2a; border-radius:8px; padding:10px; margin-bottom:10px; }

table { flex:1; width:100%; border-collapse:collapse; background:#1f1f1f; border-radius:8px; overflow:hidden;}
th,td { padding:6px 8px; text-align:left; border-bottom:1px solid #333; font-size:0.95rem; color:#e0e0e0; vertical-align:middle;}
th { background-color:#00ff7f; color:#111;}
tr:hover { background-color:#333;}
.statusBtn { padding:5px 18px; border:none; border-radius:5px; cursor:pointer; color:#111; font-weight:bold; }
td.matricula { font-weight:bold; display:flex; flex-direction:column; align-items:center; gap:6px; padding-top:10px; padding-bottom:10px; }

.badge-type { padding:4px 8px; border-radius:999px; font-size:0.78rem; font-weight:700; box-shadow:0 2px 6px rgba(0,0,0,0.45); }
.attention { display:inline-block; margin-left:6px; animation:blink 1s infinite; font-size:1rem; color:#ffcc00;}
@keyframes blink { 0%,50%,100% {opacity:1;} 25%,75% {opacity:0;} }

.deleteBtn { background:#ff4444; color:#fff; border:none; border-radius:5px; padding:4px 8px; cursor:pointer; margin-left:6px; font-size:1rem; }

.modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.75); display:flex; align-items:center; justify-content:center; z-index:999; }
.modal { background:#222; padding:20px; border-radius:8px; color:#fff; text-align:center; width:300px; }
.modal button { margin:5px; padding:6px 12px; border:none; border-radius:5px; cursor:pointer; font-weight:bold; }
.confirmBtn { background:#28a745; color:#fff; }
.cancelBtn { background:#dc3545; color:#fff; }
.countdown { margin-left:8px; font-weight:bold; }
</style>
</head>
<body>
<header>
<img src="logo.png" alt="Logo" class="logo">
<h1>Relatório de Empréstimos</h1>
<button onclick="window.location.href='index.html'">🏠 Voltar</button>
</header>

<main>
<aside id="estoque">
<h2>📦 Estoque</h2>
<div id="estoqueConteudo">Carregando...</div>
</aside>

<div class="table-wrap">
<div id="controlsHolder"></div>
<table id="relatorioTable">
<thead>
<tr>
<th>Nome</th>
<th>Matrícula</th>
<th>Tipo Cartão</th>
<th>N° Bordo Digicon</th>
<th>N° Bordo Prodata</th>
<th>N° Meia Viagem</th>
<th>Motivo</th>
<th>Matrícula Empréstimo</th>
<th>Data Retirada</th>
<th>Prazo Devolução</th>
<th>Status</th>
<th>Ação</th>
</tr>
</thead>
<tbody id="relatorioBody"></tbody>
</table>
<div class="table-bottom-spacer" aria-hidden="true"></div>
</div>
</main>

<div id="modalContainer" style="display:none;"></div>

<script src="firebaseConfig.js"></script>
<script>
let isAdmin = false; // Defina true se o usuário for admin
onAuthStateChanged(auth, user=>{
  if(user){
    // aqui você define se é admin baseado no seu campo, ex:
    // isAdmin = user.uid === 'ID_DO_ADMIN';
  }
});

/* ---------- Helpers ---------- */
function parseDate(str){ if(!str) return null; const p=str.split('/'); if(p.length!==3) return null; return new Date(Number(p[2]),Number(p[1])-1,Number(p[0])); }
function getTipoNormalizado(tipoStr){ const t=(tipoStr||'').toLowerCase(); if(t.includes('digicon')) return 'digicon'; if(t.includes('prodata')) return 'prodata'; if(t.includes('meia')) return 'meia'; return t; }

/* ---------- Badges e atenção ---------- */
function addBadges(tdMat, matCounts){
    const badgesWrap=document.createElement('div');
    badgesWrap.style.display='flex';
    badgesWrap.style.gap='6px';
    badgesWrap.style.justifyContent='center';
    badgesWrap.style.marginTop='4px';

    const createBadge=(label,count,color)=>{
        const b=document.createElement('span');
        b.className='badge-type';
        b.textContent=`${label}: ${count}`;
        b.style.background=color;
        b.style.color='#111';
        return b;
    };

    const colorDigicon = matCounts.digicon>=4?'#e74c3c':matCounts.digicon===3?'#f5b041':matCounts.digicon===2?'#f9e79f':'#bcd9a8';
    const colorProdata = matCounts.prodata>=4?'#ff6b6b':matCounts.prodata===3?'#ffb86b':matCounts.prodata===2?'#ffeaa7':'#a0e7e5';
    const colorMeia = matCounts.meia>=4?'#d980fa':matCounts.meia===3?'#c77dff':matCounts.meia===2?'#e7c6ff':'#d1c7ff';

    if(matCounts.digicon>0) badgesWrap.appendChild(createBadge('Dig',matCounts.digicon,colorDigicon));
    if(matCounts.prodata>0) badgesWrap.appendChild(createBadge('Pro',matCounts.prodata,colorProdata));
    if(matCounts.meia>0) badgesWrap.appendChild(createBadge('Meia',matCounts.meia,colorMeia));

    tdMat.appendChild(badgesWrap);

    const totalCards = matCounts.digicon + matCounts.prodata + matCounts.meia;
    if(totalCards>2){
        const att = document.createElement('span');
        att.className='attention';
        att.textContent='⚠️';
        att.style.marginLeft='6px';
        tdMat.appendChild(att);
    }
}

/* ---------- Status ---------- */
function addStatusListener(tr,id,data){
    const btn=tr.querySelector('.statusBtn');
    btn.addEventListener('click', async ()=>{
        const novoStatus = data.status==='em aberto'?'resolvido':'em aberto';
        await db.collection('emprestimos').doc(id).update({status:novoStatus});
        data.status = novoStatus;
        btn.textContent = novoStatus;
        btn.style.background = novoStatus==='em aberto'?'#ff5555':'#55ff55';
    });
}

/* ---------- Exclusão ---------- */
function criarBotaoExcluir(tr,id){
    if(!isAdmin) return;
    const td = document.createElement('td');
    const btn = document.createElement('button');
    btn.className='deleteBtn';
    btn.innerHTML='🗑️';
    btn.addEventListener('click', ()=>{
        mostrarModalConfirmacao(id);
    });
    td.appendChild(btn);
    tr.appendChild(td);
}

/* ---------- Modal ---------- */
function mostrarModalConfirmacao(id){
    const modalContainer = document.getElementById('modalContainer');
    modalContainer.innerHTML=`
        <div class="modal-overlay">
        <div class="modal">
            <p>Deseja realmente excluir este empréstimo?</p>
            <button class="confirmBtn">Sim <span class="countdown">5</span></button>
            <button class="cancelBtn">Não</button>
        </div>
        </div>
    `;
    modalContainer.style.display='block';
    const confirmBtn = modalContainer.querySelector('.confirmBtn');
    const cancelBtn = modalContainer.querySelector('.cancelBtn');
    const countdownSpan = modalContainer.querySelector('.countdown');
    let countdown=5;
    const interval = setInterval(()=>{
        countdown--;
        countdownSpan.textContent = countdown;
        if(countdown<=0){
            clearInterval(interval);
            apagarRegistro(id);
            modalContainer.style.display='none';
        }
    },1000);
    confirmBtn.onclick = ()=>{
        clearInterval(interval);
        apagarRegistro(id);
        modalContainer.style.display='none';
    };
    cancelBtn.onclick = ()=>{
        clearInterval(interval);
        modalContainer.style.display='none';
    };
}

/* ---------- Apagar registro Firestore ---------- */
async function apagarRegistro(id){
    try{
        await db.collection('emprestimos').doc(id).delete();
        carregarRelatorio();
        atualizarEstoque();
    }catch(e){
        alert('Erro ao excluir: '+e.message);
    }
}

/* ---------- Relatório ---------- */
async function carregarRelatorio(){
    const tbody=document.getElementById('relatorioBody'); 
    tbody.innerHTML='';
    const snapshot=await db.collection('emprestimos').orderBy('timestamp','desc').get();
    const counts={};
    snapshot.forEach(docSnap=>{
        const data=docSnap.data();
        const mat = data.matriculaMotorista||data.matricula||'---';
        if(!counts[mat]) counts[mat]={digicon:0, prodata:0, meia:0};
        counts[mat].digicon+=data.tipoCartao?.toLowerCase()==='digicon'?1:0;
        counts[mat].prodata+=data.tipoCartao?.toLowerCase()==='prodata'?1:0;
        counts[mat].meia+=data.tipoCartao?.toLowerCase()==='meia'?1:0;
    });

    snapshot.forEach(docSnap=>{
        const data = docSnap.data();
        const tr = document.createElement('tr');
        tr.innerHTML=`
            <td>${data.nomeMotorista||''}</td>
            <td class="matricula">${data.matriculaMotorista||data.matricula||'---'}</td>
            <td>${data.tipoCartao||''}</td>
            <td>${data.numBordoDigicon||'-'}</td>
            <td>${data.numBordoProdata||'-'}</td>
            <td>${data.numMeiaViagem||'-'}</td>
            <td>${data.motivo||''}</td>
            <td>${data.matriculaEmpresto||''}</td>
            <td>${data.dataRetirada||''}</td>
            <td>${data.prazoDevolucao||'-'}</td>
            <td><button class="statusBtn" style="background:${data.status==='em aberto'?'#ff5555':'#55ff55'};">${data.status}</button></td>
        `;
        addBadges(tr.querySelector('td.matricula'), counts[data.matriculaMotorista||data.matricula||'---']);
        addStatusListener(tr, docSnap.id, data);
        criarBotaoExcluir(tr, docSnap.id);
        tbody.appendChild(tr);
    });
}

/* ---------- Inicialização ---------- */
carregarRelatorio();
</script>

<footer class="footer">Relatório atualizado em tempo real</footer>
</body>
</html>
