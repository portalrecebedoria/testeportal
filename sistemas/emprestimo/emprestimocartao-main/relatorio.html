<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Relatório de Empréstimos</title>
<link rel="stylesheet" href="style.css">

<!-- Favicon -->
<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

<!-- Firebase SDKs (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
/* --- mantive seu estilo original e adicionei classes novas --- */
body {
    background-color: #121212;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #e0e0e0;
    margin: 0;
    padding: 20px;
}
header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
}
header img.logo { height: 50px; }
header h1 { flex-grow:1; font-size: 1.5rem; color: #00ff7f; }
header button {
    padding:5px 10px; border-radius:5px; border:none;
    cursor:pointer; background:#00ff7f; color:#111;
}
main { display: flex; gap: 20px; align-items:flex-start; }
#estoque {
    width: 260px; background: #1e1e1e;
    padding: 15px; border-radius: 10px; color: #e0e0e0;
    height: fit-content;
}
#estoque h2 { color: #00ff7f; font-size: 1.1rem; margin-bottom: 10px; }
.cardEstoque {
    background: #2a2a2a; border-radius: 8px;
    padding: 10px; margin-bottom: 10px;
}
.cardEstoque h3 { margin: 0; font-size: 1rem; color: #00b894; }
.cardEstoque p { margin: 3px 0; font-size: 0.9rem; }

.controls-bar {
  display:flex;
  gap:12px;
  align-items:center;
  margin-bottom:12px;
  flex-wrap:wrap;
}

/* filtro mes + tipos + numero + counts */
#monthSelect {
  padding:8px 10px;
  border-radius:8px;
  background:#222;
  color:#fff;
  border:1px solid rgba(255,255,255,0.06);
  font-weight:600;
}
.filterTipoBtn {
  padding:6px 10px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.06);
  background:#222;
  color:#fff;
  cursor:pointer;
  font-weight:700;
}
#btnTodosTipos {
  background:#00ff7f;
  color:#111;
  font-weight:800;
  border: none;
}

#cardNumberFilter {
  width:72px;
  padding:6px 8px;
  border-radius:8px;
  background:#222;
  color:#fff;
  border:1px solid rgba(255,255,255,0.06);
}

#matriculaFilter {
  width:110px;
  padding:6px 8px;
  border-radius:8px;
  background:#222;
  color:#fff;
  border:1px solid rgba(255,255,255,0.06);
}

.count-filters { display:flex; gap:8px; align-items:center; }

/* count buttons */
.countBtn {
  padding:6px 10px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.06);
  background:#222;
  color:#fff;
  cursor:pointer;
  font-weight:700;
  opacity: 1;
}
.countBtn.inactive { opacity: 0.4; }

.count-filters label { font-size:0.9rem; display:flex; gap:6px; align-items:center; }

.legend {
  margin-left:auto;
  display:flex;
  gap:10px;
  align-items:center;
  font-size:0.9rem;
}
.legend .item { display:flex; gap:8px; align-items:center; }

.table-wrap { flex:1; }

table {
    width: 100%;
    border-collapse: collapse;
    background: #1f1f1f;
    border-radius: 8px;
    overflow: hidden;
}
th, td {
    padding: 6px 8px;
    text-align: left;
    border-bottom: 1px solid #333;
    font-size: 0.95rem;
    color: #e0e0e0;
    vertical-align: middle;
}
th { background-color: #00ff7f; color: #111; }
tr:hover { background-color: #333; }
.statusBtn {
    padding:5px 18px; border:none; border-radius:5px;
    cursor:pointer; color:#111; font-weight: bold;
}

/* matrícula cell with badges container */
td.matricula {
  font-weight: bold;
  text-align: center;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
  padding-top:10px;
  padding-bottom:10px;
}

/* badge small */
.badge-type {
  padding:4px 8px;
  border-radius:999px;
  font-size:0.78rem;
  font-weight:700;
  box-shadow: 0 2px 6px rgba(0,0,0,0.45);
}

/* legend swatches */
.legend-swatch {
  width:16px; height:12px; border-radius:4px; display:inline-block;
}

/* bottom spacer so list not cut */
.table-bottom-spacer { height: 70px; }

/* footer */
.footer { margin-top:18px; color:#888; text-align:center; }

/* responsive tweaks */
@media(max-width:900px){
  main { flex-direction:column; }
  #estoque { width:100%; }
}
</style>
</head>
<body>

<header>
    <img src="logo.png" alt="Logo" class="logo">
    <h1>Relatório de Empréstimos</h1>
    <button onclick="window.location.href='index.html'">🏠 Voltar</button>
</header>

<main>
    <aside id="estoque">
        <h2>📦 Estoque</h2>
        <div id="estoqueConteudo">Carregando...</div>
    </aside>

    <div class="table-wrap">
        <div id="controlsHolder"></div>

        <table id="relatorioTable">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Matrícula</th>
                    <th>Tipo Cartão</th>
                    <th>N° Bordo Digicon</th>
                    <th>N° Bordo Prodata</th>
                    <th>N° Meia Viagem</th>
                    <th>Motivo</th>
                    <th>Matrícula Empréstimo</th>
                    <th>Data Retirada</th>
                    <th>Prazo Devolução</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="relatorioBody"></tbody>
        </table>

        <div class="table-bottom-spacer" aria-hidden="true"></div>
    </div>
</main>

<script src="firebaseConfig.js"></script>
<script>
/* ---------- atualizarEstoque (mantive lógica original) ---------- */
async function atualizarEstoque() {
  const estoqueDiv = document.getElementById("estoqueConteudo");
  estoqueDiv.innerHTML = "Atualizando...";

  const total = { digicon: 10, prodata: 10, meiaViagem: 10 };
  const emprestados = { digicon: [], prodata: [], meiaViagem: [] };

  const snapshot = await db.collection("emprestimos")
    .where("status", "==", "em aberto")
    .get();

  snapshot.forEach(doc => {
    const data = doc.data();
    const tipo = (data.tipoCartao || '').toString().toLowerCase();
    if (tipo === "digicon" && data.numBordoDigicon) emprestados.digicon.push(Number(data.numBordoDigicon));
    if (tipo === "prodata" && data.numBordoProdata) emprestados.prodata.push(Number(data.numBordoProdata));
    if (data.numMeiaViagem) emprestados.meiaViagem.push(Number(data.numMeiaViagem));
  });

  function gerarLista(tipo) {
    const chave = tipo;
    const todos = Array.from({ length: total[chave] }, (_, i) => i + 1);
    const disponiveis = todos.filter(n => !emprestados[chave].includes(n));
    const titulo = chave === 'digicon' ? 'Bordo Digicon' : chave === 'prodata' ? 'Bordo Prodata' : 'Meia Viagem';
    return `
      <div class="cardEstoque">
        <h3>${titulo}</h3>
        <p><b>Qtd. Disponível:</b> ${disponiveis.length}</p>
        <p><b>Qtd. Emprestado:</b> ${emprestados[chave].length}</p>
        <p><b>N° Disponíveis:</b> ${disponiveis.join(', ') || '-'}</p>
        <p><b>N° Emprestados:</b> ${emprestados[chave].join(', ') || '-'}</p>
      </div>`;
  }

  estoqueDiv.innerHTML =
    gerarLista("digicon") +
    gerarLista("prodata") +
    gerarLista("meiaViagem");
}

/* ---------- Helpers para mês ---------- */
function getMonthId(date = new Date()) {
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, '0');
  return `${y}-${m}`;
}
function monthIdToRange(monthId) {
  const [y, m] = monthId.split('-').map(Number);
  const first = new Date(y, m - 1, 1, 0, 0, 0);
  const last = new Date(y, m, 0, 23, 59, 59, 999);
  return { start: first, end: last };
}
function formatMonthLabel(monthId) {
  const [y, m] = monthId.split('-').map(Number);
  const d = new Date(y, m - 1, 1);
  return d.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
}

/* ---------- Cria controles dinâmicos ---------- */
function criarControles() {
  const container = document.createElement('div');
  container.className = 'controls-bar';

  const monthSelect = document.createElement('select');
  monthSelect.id = 'monthSelect';
  monthSelect.title = 'Selecionar mês';
  const current = new Date();
  for (let i = 0; i < 12; i++) {
    const d = new Date(current.getFullYear(), current.getMonth() - i, 1);
    const id = getMonthId(d);
    const opt = document.createElement('option');
    opt.value = id;
    opt.textContent = formatMonthLabel(id);
    monthSelect.appendChild(opt);
  }

  const toggles = document.createElement('div');
  toggles.style.display = 'flex';
  toggles.style.gap = '8px';
  toggles.style.alignItems = 'center';
  ['digicon','prodata','meia'].forEach(key => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'filterTipoBtn';
    btn.dataset.tipo = key;
    btn.textContent = key === 'digicon' ? 'Digicon' : key === 'prodata' ? 'Prodata' : 'Meia';
    btn.dataset.active = 'true';
    toggles.appendChild(btn);
  });

  const btnTodos = document.createElement('button');
  btnTodos.type = 'button';
  btnTodos.id = 'btnTodosTipos';
  btnTodos.textContent = 'Todos';
  toggles.insertBefore(btnTodos, toggles.firstChild);

  const cardNumberFilter = document.createElement('input');
  cardNumberFilter.type = 'number';
  cardNumberFilter.id = 'cardNumberFilter';
  cardNumberFilter.placeholder = 'Nº card';

  const matriculaFilter = document.createElement('input');
  matriculaFilter.type = 'text';
  matriculaFilter.id = 'matriculaFilter';
  matriculaFilter.placeholder = 'Matricula';

  const countFilters = document.createElement('div');
  countFilters.className = 'count-filters';
  ['1','2','3','4+'].forEach(lbl => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'countBtn';
    btn.dataset.count = lbl;
    btn.dataset.active = 'true';
    btn.textContent = lbl;
    countFilters.appendChild(btn);
  });

  const legend = document.createElement('div');
  legend.className = 'legend';
  const thresholds = [
    { label: '1', color: '#bcd9a8' },
    { label: '2', color: '#f9e79f' },
    { label: '3', color: '#f5b041' },
    { label: '4+', color: '#e74c3c' }
  ];
  thresholds.forEach(t => {
    const item = document.createElement('div');
    item.className = 'item';
    const sw = document.createElement('span');
    sw.className = 'legend-swatch';
    sw.style.background = t.color;
    const lbl = document.createElement('span');
    lbl.textContent = t.label;
    item.appendChild(sw);
    item.appendChild(lbl);
    legend.appendChild(item);
  });

  container.appendChild(monthSelect);
  container.appendChild(toggles);
  container.appendChild(cardNumberFilter);
  container.appendChild(matriculaFilter);
  container.appendChild(countFilters);
  container.appendChild(legend);

  document.getElementById('controlsHolder').appendChild(container);

  monthSelect.addEventListener('change', carregarRelatorio);
  toggles.querySelectorAll('.filterTipoBtn').forEach(btn => {
    btn.addEventListener('click', () => {
      btn.dataset.active = btn.dataset.active === 'true' ? 'false' : 'true';
      carregarRelatorio();
    });
  });
  btnTodos.addEventListener('click', () => {
    toggles.querySelectorAll('.filterTipoBtn').forEach(b => b.dataset.active='true');
    carregarRelatorio();
  });

  cardNumberFilter.addEventListener('input', carregarRelatorio);
  matriculaFilter.addEventListener('input', carregarRelatorio);
  countFilters.querySelectorAll('button.countBtn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      btn.dataset.active = btn.dataset.active==='true'?'false':'true';
      carregarRelatorio();
    });
  });

  monthSelect.value = getMonthId(new Date());
}

/* ---------- Carregar relatório (corrigido para filtro cartão linha por linha) ---------- */
async function carregarRelatorio() {
  const tbody = document.getElementById('relatorioBody');
  tbody.innerHTML = '';

  const selectedMonth = document.getElementById('monthSelect')?.value || getMonthId(new Date());
  const { start, end } = monthIdToRange(selectedMonth);

  const activeTipos = Array.from(document.querySelectorAll('.filterTipoBtn'))
    .filter(b => b.dataset.active==='true')
    .map(b => b.dataset.tipo);

  const selectedCounts = Array.from(document.querySelectorAll('.countBtn'))
    .filter(b => b.dataset.active==='true')
    .map(b => b.dataset.count);

  const cardNumberValue = (document.getElementById('cardNumberFilter')?.value || '').trim();
  const matriculaFilterValue = (document.getElementById('matriculaFilter')?.value || '').trim();

  const counts = {};
  const rows = [];

  try {
    const snapshot = await db.collection('emprestimos').orderBy('timestamp','desc').get();
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      let docDate = null;
      if (data.timestamp && data.timestamp.toDate) docDate = data.timestamp.toDate();
      else if (data.dataRetirada) {
        const parts = data.dataRetirada.split(' ')[0].split('/');
        if(parts.length===3) docDate = new Date(Number(parts[2]), Number(parts[1])-1, Number(parts[0]));
      }
      if(!docDate || docDate<start || docDate>end) return;

      const tipoRaw = (data.tipoCartao||'').toLowerCase();
      const tipo = tipoRaw.includes('digicon')?'digicon':tipoRaw.includes('prodata')?'prodata':(tipoRaw.includes('meia')?'meia':tipoRaw);
      if(!activeTipos.includes(tipo)) return;

      const mat = data.matriculaMotorista || data.matricula || '---';
      if(!counts[mat]) counts[mat] = {digicon:0, prodata:0, meia:0};
      if(tipo==='digicon') counts[mat].digicon +=1;
      if(tipo==='prodata') counts[mat].prodata +=1;
      if(tipo==='meia') counts[mat].meia +=1;

      rows.push({id:docSnap.id, data, tipo, docDate});
    });

    for(const r of rows){
      const d = r.data;
      const matKey = d.matriculaMotorista || d.matricula || '---';

      // --- FILTRO MATRÍCULA ---
      if(matriculaFilterValue!=='' && !(matKey+"").includes(matriculaFilterValue)) continue;

      // --- FILTRO NÚMERO DO CARTÃO ---
      if(cardNumberValue!==''){
        let numLinha='';
        if(r.tipo==='digicon') numLinha = d.numBordoDigicon||'';
        if(r.tipo==='prodata') numLinha = d.numBordoProdata||'';
        if(r.tipo==='meia') numLinha = d.numMeiaViagem||'';
        if(numLinha.toString() !== cardNumberValue) continue;
      }

      // --- FILTRO CONTAGEM ---
      const matCounts = counts[matKey] || {digicon:0,prodata:0,meia:0};
      const totalForActive = (activeTipos.includes('digicon')?matCounts.digicon:0)
                           + (activeTipos.includes('prodata')?matCounts.prodata:0)
                           + (activeTipos.includes('meia')?matCounts.meia:0);
      let label = totalForActive>=4?'4+':totalForActive.toString();
      if(!selectedCounts.includes(label)) continue;

      // Renderiza linha
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${d.nome || '-'}</td>
        <td class="matricula">${matKey}</td>
        <td>${r.tipo}</td>
        <td>${d.numBordoDigicon || '-'}</td>
        <td>${d.numBordoProdata || '-'}</td>
        <td>${d.numMeiaViagem || '-'}</td>
        <td>${d.motivo || '-'}</td>
        <td>${d.matriculaEmprestimo || '-'}</td>
        <td>${d.dataRetirada || '-'}</td>
        <td>${d.prazoDevolucao || '-'}</td>
        <td>${d.status || '-'}</td>
      `;
      tbody.appendChild(tr);
    }

  } catch(err){
    console.error(err);
    tbody.innerHTML = '<tr><td colspan="11">Erro ao carregar dados</td></tr>';
  }
}

/* ---------- Inicialização ---------- */
window.addEventListener('DOMContentLoaded',()=>{
  criarControles();
  atualizarEstoque();
  carregarRelatorio();
});
</script>

<footer class="footer">
Relatório gerado automaticamente - © 2025
</footer>
</body>
</html>
