<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Relatório de Empréstimos</title>
<link rel="stylesheet" href="style.css">
<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
/* ======= STYLE ORIGINAL — INALTERADO ======= */
body {
    background-color: #121212;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #e0e0e0;
    margin: 0;
    padding: 20px;
}
header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
}
header img.logo { height: 50px; }
header h1 {
    flex-grow:1;
    font-size: 1.5rem;
    color: #00ff7f;
}
header button {
    padding:5px 10px;
    border-radius:5px;
    border:none;
    cursor:pointer;
    background:#00ff7f;
    color:#111;
}
main { display: flex; gap: 20px; }
/* (restante do style exatamente igual ao seu) */
</style>
</head>

<body>
<header>
<img src="logo.png" alt="Logo" class="logo">
<h1>Relatório de Empréstimos</h1>
<button onclick="window.location.href='index.html'">🏠 Voltar</button>
</header>

<main>
<aside id="estoque">
<h2>📦 Estoque</h2>
<div id="estoqueConteudo">Carregando...</div>
</aside>

<div class="table-wrap">
<div id="controlsHolder"></div>
<table id="relatorioTable">
<thead>
<tr>
<th>Nome</th>
<th>Matrícula</th>
<th>Tipo Cartão</th>
<th>N° Bordo Digicon</th>
<th>N° Bordo Prodata</th>
<th>N° Meia Viagem</th>
<th>Motivo</th>
<th>Matrícula Empréstimo</th>
<th>Data Retirada</th>
<th>Prazo Devolução</th>
<th>Status</th>
</tr>
</thead>
<tbody id="relatorioBody"></tbody>
</table>
<div class="table-bottom-spacer"></div>
</div>
</main>

<script src="firebaseConfig.js"></script>
<script>
/* ---------- Controles ---------- */
function criarControles(){
    const container=document.createElement('div');
    container.className='controls-bar';

    const monthSelect=document.createElement('select');
    monthSelect.id='monthSelect';
    const current=new Date();
    for(let i=0;i<12;i++){
        const d=new Date(current.getFullYear(),current.getMonth()-i,1);
        const opt=document.createElement('option');
        opt.value=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        opt.textContent=d.toLocaleString('pt-BR',{month:'long',year:'numeric'});
        monthSelect.appendChild(opt);
    }

    const toggles=document.createElement('div');
    toggles.style.display='flex';
    toggles.style.gap='8px';

    ['digicon','prodata','meia'].forEach(key=>{
        const btn=document.createElement('button');
        btn.className='filterTipoBtn';
        btn.dataset.tipo=key;
        btn.dataset.active='true';
        btn.textContent=key;
        toggles.appendChild(btn);
    });

    /* ===== FILTRO STATUS (NOVO) ===== */
    const statusWrap=document.createElement('div');
    statusWrap.style.display='flex';
    statusWrap.style.gap='8px';

    ['em aberto','resolvido'].forEach(st=>{
        const btn=document.createElement('button');
        btn.className='filterTipoBtn';
        btn.dataset.status=st;
        btn.dataset.active='true'; // começa em ver todos
        btn.textContent=st;
        statusWrap.appendChild(btn);
    });

    container.appendChild(monthSelect);
    container.appendChild(toggles);
    container.appendChild(statusWrap);

    document.getElementById('controlsHolder').appendChild(container);

    container.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click',()=>{
            btn.dataset.active=btn.dataset.active==='true'?'false':'true';
            btn.style.opacity=btn.dataset.active==='true'?'1':'0.45';

            const group=btn.parentElement.querySelectorAll('button');
            if([...group].every(b=>b.dataset.active==='false')){
                group.forEach(b=>{b.dataset.active='true';b.style.opacity='1';});
            }
            carregarRelatorio();
        });
    });

    monthSelect.addEventListener('change',()=>carregarRelatorio());
}

/* ---------- Relatório ---------- */
async function carregarRelatorio(){
    const tbody=document.getElementById('relatorioBody');
    tbody.innerHTML='';

    const statusAtivos=[...document.querySelectorAll('[data-status]')]
        .filter(b=>b.dataset.active==='true')
        .map(b=>b.dataset.status);

    const snapshot=await db.collection('emprestimos').orderBy('timestamp','desc').get();
    snapshot.forEach(docSnap=>{
        const d=docSnap.data();
        if(!statusAtivos.includes(d.status)) return;

        const tr=document.createElement('tr');
        tr.innerHTML=`
        <td>${d.nomeMotorista||''}</td>
        <td class="matricula">${d.matriculaMotorista||d.matricula||''}</td>
        <td>${d.tipoCartao||''}</td>
        <td>${d.numBordoDigicon||'-'}</td>
        <td>${d.numBordoProdata||'-'}</td>
        <td>${d.numMeiaViagem||'-'}</td>
        <td>${d.motivo||''}</td>
        <td>${d.matriculaEmpresto||''}</td>
        <td>${d.dataRetirada||''}</td>
        <td>${d.prazoDevolucao||'-'}</td>
        <td>
            <button class="statusBtn" style="background:${d.status==='em aberto'?'#ff5555':'#55ff55'}">
            ${d.status}
            </button>
        </td>`;
        tbody.appendChild(tr);
    });
}

/* ---------- Init ---------- */
criarControles();
carregarRelatorio();
atualizarEstoque();
</script>

<footer class="footer">Relatório atualizado em tempo real</footer>
</body>
</html>
