<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Relatório de Empréstimos</title>
<link rel="stylesheet" href="style.css">
<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
body {
    background-color: #121212;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #e0e0e0;
    margin: 0;
    padding: 20px;
}
header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
}
header img.logo { height: 50px; }
header h1 {
    flex-grow:1;
    font-size: 1.5rem;
    color: #00ff7f;
}
header button {
    padding:5px 10px;
    border-radius:5px;
    border:none;
    cursor:pointer;
    background:#00ff7f;
    color:#111;
}
main { display: flex; gap: 20px; }

/* ===== Estoque ===== */
#estoque {
    width: 400px;
    background: #1e1e1e;
    padding: 15px;
    border-radius: 10px;
    color: #e0e0e0;
    height: fit-content;
}
#estoque h2 {
    color: #00ff7f;
    font-size: 1.1rem;
    margin-bottom: 10px;
}
#estoqueConteudo {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.cardEstoque {
    background: #2a2a2a;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 10px;
}
.cardEstoque h3 {
    margin: 0;
    font-size: 1rem;
    color: #00b894;
}
.cardEstoque p {
    margin: 3px 0;
    font-size: 0.9rem;
}

/* Atenção piscante ⚠️ */
.attention {
    display:inline-block;
    margin-left:6px;
    animation: blink 1s infinite;
}
@keyframes blink {
    0%,50%,100% { opacity:1; }
    25%,75% { opacity:0; }
}

.controls-bar {
    display:flex;
    gap:12px;
    align-items:center;
    margin-bottom:12px;
    flex-wrap:wrap;
}
#monthSelect,
.filterTipoBtn,
.filterStatusBtn,
#cardNumberFilter,
#matriculaFilter,
.countBtn {
    font-weight:600;
    border-radius:8px;
    padding:6px 10px;
    border:1px solid rgba(255,255,255,0.06);
    background:#222;
    color:#fff;
    cursor:pointer;
}
.count-filters { display:flex; gap:8px; align-items:center; }
.count-filters label { font-size:0.9rem; display:flex; gap:6px; align-items:center; }
.countBtn.inactive { background:#111; color:#888; }
.legend { margin-left:auto; display:flex; gap:10px; align-items:center; font-size:0.9rem; }
.legend .item { display:flex; gap:8px; align-items:center; }

.table-wrap { flex:1; }
table {
    flex: 1;
    width: 100%;
    border-collapse: collapse;
    background: #1f1f1f;
    border-radius: 8px;
    overflow: hidden;
}
th, td {
    padding: 5px;
    text-align: left;
    border-bottom: 1px solid #333;
    font-size: 0.95rem;
    color: #e0e0e0;
}
th { background-color: #00ff7f; color: #111; }
tr:hover { background-color: #333; }
.statusBtn {
    padding:5px 25px;
    border:none;
    border-radius:5px;
    cursor:pointer;
    color:#111;
    font-weight: bold;
}
td.matricula {
    font-weight: bold;
    text-align: center;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:6px;
    padding-top:10px;
    padding-bottom:10px;
}
.badge-type {
    padding:4px 8px;
    border-radius:999px;
    font-size:0.78rem;
    font-weight:700;
    box-shadow: 0 2px 6px rgba(0,0,0,0.45);
}
.legend-swatch { width:16px; height:12px; border-radius:4px; display:inline-block; }
.table-bottom-spacer { height: 70px; }
.footer { margin-top:18px; color:#888; text-align:center; }

@media(max-width:900px){
    main { flex-direction:column; }
    #estoque { width:100%; }
}
</style>
</head>

<body>
<header>
<img src="logo.png" alt="Logo" class="logo">
<h1>Relatório de Empréstimos</h1>
<button onclick="window.location.href='index.html'">🏠 Voltar</button>
</header>

<main>
<aside id="estoque">
<h2>📦 Estoque</h2>
<div id="estoqueConteudo">Carregando...</div>
</aside>

<div class="table-wrap">
<div id="controlsHolder"></div>

<table id="relatorioTable">
<thead>
<tr>
<th>Nome</th>
<th>Matrícula</th>
<th>Tipo Cartão</th>
<th>N° Bordo Digicon</th>
<th>N° Bordo Prodata</th>
<th>N° Meia Viagem</th>
<th>Motivo</th>
<th>Matrícula Empréstimo</th>
<th>Data Retirada</th>
<th>Prazo Devolução</th>
<th>Status</th>
</tr>
</thead>
<tbody id="relatorioBody"></tbody>
</table>
<div class="table-bottom-spacer" aria-hidden="true"></div>
</div>
</main>

<script src="firebaseConfig.js"></script>

<script>
/* ---------- Helpers ---------- */
function parseDate(str){ if(!str) return null; const p=str.split('/'); if(p.length!==3) return null; return new Date(+p[2],p[1]-1,+p[0]); }
function getTipoNormalizado(t){ t=(t||'').toLowerCase(); if(t.includes('digicon'))return'digicon'; if(t.includes('prodata'))return'prodata'; if(t.includes('meia'))return'meia'; return t; }

/* ---------- Controles ---------- */
function criarControles(){
    const c=document.createElement('div'); c.className='controls-bar';

    const m=document.createElement('select'); m.id='monthSelect';
    const now=new Date();
    for(let i=0;i<12;i++){
        const d=new Date(now.getFullYear(),now.getMonth()-i,1);
        const o=document.createElement('option');
        o.value=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        o.textContent=d.toLocaleString('pt-BR',{month:'long',year:'numeric'});
        m.appendChild(o);
    }

    const tipos=document.createElement('div');
    tipos.style.display='flex'; tipos.style.gap='8px';
    ['digicon','prodata','meia'].forEach(t=>{
        const b=document.createElement('button');
        b.className='filterTipoBtn';
        b.dataset.tipo=t;
        b.dataset.active='true';
        b.textContent=t;
        b.onclick=()=>{ b.dataset.active=b.dataset.active==='true'?'false':'true'; b.style.opacity=b.dataset.active==='true'?'1':'0.45'; carregarRelatorio(); };
        tipos.appendChild(b);
    });

    // ===== FILTRO STATUS (NOVO) =====
    const statusWrap=document.createElement('div');
    statusWrap.style.display='flex'; statusWrap.style.gap='8px';
    ['em aberto','resolvido'].forEach(st=>{
        const b=document.createElement('button');
        b.className='filterStatusBtn';
        b.dataset.status=st;
        b.dataset.active='true';
        b.textContent=st;
        b.onclick=()=>{
            b.dataset.active=b.dataset.active==='true'?'false':'true';
            b.style.opacity=b.dataset.active==='true'?'1':'0.45';
            const all=[...statusWrap.querySelectorAll('.filterStatusBtn')];
            if(all.every(x=>x.dataset.active==='false')){
                all.forEach(x=>{x.dataset.active='true';x.style.opacity='1';});
            }
            carregarRelatorio();
        };
        statusWrap.appendChild(b);
    });

    const card=document.createElement('input'); card.id='cardNumberFilter'; card.placeholder='Nº card';
    const mat=document.createElement('input'); mat.id='matriculaFilter'; mat.placeholder='Matricula';

    c.appendChild(m);
    c.appendChild(tipos);
    c.appendChild(statusWrap);
    c.appendChild(card);
    c.appendChild(mat);

    document.getElementById('controlsHolder').appendChild(c);

    m.onchange=card.oninput=mat.oninput=()=>carregarRelatorio();
}

/* ---------- Relatório ---------- */
async function carregarRelatorio(){
    const tb=document.getElementById('relatorioBody');
    tb.innerHTML='';

    const statusAtivos=[...document.querySelectorAll('.filterStatusBtn')]
        .filter(b=>b.dataset.active==='true')
        .map(b=>b.dataset.status);

    const snap=await db.collection('emprestimos').orderBy('timestamp','desc').get();
    snap.forEach(doc=>{
        const d=doc.data();
        if(!statusAtivos.includes((d.status||'').toLowerCase())) return;

        const tr=document.createElement('tr');
        tr.innerHTML=`
        <td>${d.nomeMotorista||''}</td>
        <td>${d.matricula||''}</td>
        <td>${d.tipoCartao||''}</td>
        <td>${d.numBordoDigicon||'-'}</td>
        <td>${d.numBordoProdata||'-'}</td>
        <td>${d.numMeiaViagem||'-'}</td>
        <td>${d.motivo||''}</td>
        <td>${d.matriculaEmpresto||''}</td>
        <td>${d.dataRetirada||''}</td>
        <td>${d.prazoDevolucao||'-'}</td>
        <td><button class="statusBtn" style="background:${d.status==='em aberto'?'#ff5555':'#55ff55'};">${d.status}</button></td>`;
        tb.appendChild(tr);
    });
}

/* ---------- Init ---------- */
criarControles();
carregarRelatorio();
</script>

<footer class="footer">Relatório atualizado em tempo real</footer>
</body>
</html>
