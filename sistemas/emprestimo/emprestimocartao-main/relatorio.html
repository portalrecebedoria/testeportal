<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Relatório de Empréstimos</title>

<link rel="icon" href="favicon.ico">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
body { background:#121212; color:#e0e0e0; font-family:Segoe UI; margin:0; padding:20px; }
header { display:flex; gap:15px; align-items:center; margin-bottom:20px; }
header img { height:50px; }
header h1 { flex:1; color:#00ff7f; }
header button { background:#00ff7f; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; }

main { display:flex; gap:20px; }

#estoque {
  width:380px;
  background:#1e1e1e;
  padding:15px;
  border-radius:10px;
  max-height:650px;
  overflow:auto;
}

.cardEstoque {
  background:#2a2a2a;
  padding:12px;
  border-radius:8px;
}

.controls-bar { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; }

select,input,button {
  background:#222;
  color:#fff;
  border-radius:6px;
  padding:6px 10px;
  border:1px solid #333;
}

table { width:100%; border-collapse:collapse; background:#1f1f1f; }
th { background:#00ff7f; color:#111; }
td,th { padding:6px; border-bottom:1px solid #333; }

td.matricula {
  display:flex;
  align-items:center;
  gap:6px;
  flex-wrap:nowrap;
}

.attention {
  animation: blink 1s infinite;
}

@keyframes blink {
  50% { opacity:0; }
}

.statusBtn { border:none; padding:4px 14px; border-radius:6px; font-weight:bold; cursor:pointer; }

.deleteBtn {
  background:none;
  border:none;
  font-size:18px;
  cursor:pointer;
  color:#ff5555;
}

.modal-bg {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.75);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:9999;
}

.modal {
  background:#222;
  padding:20px;
  border-radius:8px;
  text-align:center;
}
</style>
</head>

<body>

<header>
  <img src="logo.png">
  <h1>Relatório de Empréstimos</h1>
  <button onclick="location.href='index.html'">🏠 Voltar</button>
</header>

<main>
  <aside id="estoque">
    <h2>📦 Estoque</h2>
    <div id="estoqueConteudo">Carregando...</div>
  </aside>

  <div style="flex:1">
    <div id="controlsHolder"></div>

    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>Matrícula</th>
          <th>Tipo</th>
          <th>Digicon</th>
          <th>Prodata</th>
          <th>Meia</th>
          <th>Status</th>
          <th>Excluir</th>
        </tr>
      </thead>
      <tbody id="relatorioBody"></tbody>
    </table>
  </div>
</main>

<script src="firebaseConfig.js"></script>

<script>
let isAdmin = false;

/* 🔐 Auth SEM variável auth */
firebase.auth().onAuthStateChanged(user=>{
  isAdmin = !!user && user.uid === "ID_DO_ADMIN";
  carregarRelatorio();
});

/* ========= CONTROLES ========= */
function criarControles(){
  const div=document.createElement("div");
  div.className="controls-bar";

  const statusSel=document.createElement("select");
  statusSel.id="statusFilter";
  statusSel.innerHTML=`
    <option value="todos">Todos</option>
    <option value="em aberto">Em aberto</option>
    <option value="resolvido">Resolvido</option>
  `;

  statusSel.onchange=carregarRelatorio;
  div.appendChild(statusSel);

  document.getElementById("controlsHolder").appendChild(div);
}

/* ========= RELATÓRIO ========= */
async function carregarRelatorio(){
  const tbody=document.getElementById("relatorioBody");
  tbody.innerHTML="";

  const statusFiltro=document.getElementById("statusFilter")?.value;

  const snap=await db.collection("emprestimos").get();

  snap.forEach(doc=>{
    const d=doc.data();
    if(statusFiltro!=="todos" && d.status!==statusFiltro) return;

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${d.nomeMotorista||""}</td>
      <td class="matricula">${d.matricula||""}${d.status==="em aberto"?"<span class='attention'>⚠️</span>":""}</td>
      <td>${d.tipoCartao||""}</td>
      <td>${d.numBordoDigicon||"-"}</td>
      <td>${d.numBordoProdata||"-"}</td>
      <td>${d.numMeiaViagem||"-"}</td>
      <td><button class="statusBtn" style="background:${d.status==="em aberto"?"#ff5555":"#55ff55"}">${d.status}</button></td>
      <td>${isAdmin?'<button class="deleteBtn">🗑️</button>':""}</td>
    `;

    tbody.appendChild(tr);

    if(isAdmin){
      tr.querySelector(".deleteBtn").onclick=()=>confirmDelete(doc.id,tr);
    }
  });
}

/* ========= MODAL ========= */
function confirmDelete(id,tr){
  const bg=document.createElement("div");
  bg.className="modal-bg";
  const m=document.createElement("div");
  m.className="modal";
  m.innerHTML=`<p>Excluir empréstimo?</p><button id="sim">Sim (5)</button><button id="nao">Não</button>`;
  bg.appendChild(m);
  document.body.appendChild(bg);

  let t=5;
  const btn=m.querySelector("#sim");
  const i=setInterval(()=>{
    t--;
    btn.textContent=`Sim (${t})`;
    if(t<=0){ clearInterval(i); excluir(id,tr,bg); }
  },1000);

  btn.onclick=()=>{ clearInterval(i); excluir(id,tr,bg); };
  m.querySelector("#nao").onclick=()=>{ clearInterval(i); bg.remove(); };
}

async function excluir(id,tr,bg){
  await db.collection("emprestimos").doc(id).delete();
  tr.remove();
  bg.remove();
}

/* INIT */
criarControles();
carregarRelatorio();
</script>

</body>
</html>
