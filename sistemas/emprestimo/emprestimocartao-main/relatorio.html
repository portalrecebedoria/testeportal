<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Relatório de Empréstimos</title>

<link rel="stylesheet" href="style.css">
<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
/* === (CSS ORIGINAL — NÃO ALTERADO) === */
body {
    background-color: #121212;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #e0e0e0;
    margin: 0;
    padding: 20px;
}
header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
}
header img.logo { height: 50px; }
header h1 {
    flex-grow:1;
    font-size: 1.5rem;
    color: #00ff7f;
}
header button {
    padding:5px 10px;
    border-radius:5px;
    border:none;
    cursor:pointer;
    background:#00ff7f;
    color:#111;
}
main { display: flex; gap: 20px; }

/* Estoque */
#estoque {
    width: 400px;
    background: #1e1e1e;
    padding: 15px;
    border-radius: 10px;
    height: fit-content;
}
#estoque h2 { color:#00ff7f; }
#estoqueConteudo { display:flex; flex-direction:column; gap:10px; }
.cardEstoque { background:#2a2a2a; border-radius:8px; padding:10px; }

/* Atenção */
.attention { animation: blink 1s infinite; margin-left:6px; }
@keyframes blink { 0%,50%,100%{opacity:1} 25%,75%{opacity:0} }

.controls-bar {
    display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px;
}
#monthSelect, .filterTipoBtn, #cardNumberFilter, #matriculaFilter, .countBtn, #statusFilter {
    background:#222;
    color:#fff;
    border-radius:8px;
    padding:6px 10px;
    cursor:pointer;
    border:1px solid rgba(255,255,255,0.08);
}

.table-wrap { flex:1; }
table {
    width:100%;
    border-collapse:collapse;
    background:#1f1f1f;
}
th { background:#00ff7f; color:#111; }
th,td { padding:5px; border-bottom:1px solid #333; }

.statusBtn {
    padding:5px 20px;
    border:none;
    border-radius:5px;
    font-weight:bold;
    cursor:pointer;
}

/* 🔹 ADICIONADO */
.deleteBtn {
    background:#e74c3c;
    color:#fff;
    border:none;
    border-radius:5px;
    padding:5px 10px;
    cursor:pointer;
}
</style>
</head>

<body>

<header>
    <img src="logo.png" class="logo">
    <h1>Relatório de Empréstimos</h1>
    <button onclick="location.href='index.html'">🏠 Voltar</button>
</header>

<main>

<aside id="estoque">
    <h2>📦 Estoque</h2>
    <div id="estoqueConteudo">Carregando...</div>
</aside>

<div class="table-wrap">
    <div id="controlsHolder"></div>

    <table>
        <thead>
        <tr>
            <th>Nome</th>
            <th>Matrícula</th>
            <th>Tipo</th>
            <th>Digicon</th>
            <th>Prodata</th>
            <th>Meia</th>
            <th>Motivo</th>
            <th>Matrícula Empréstimo</th>
            <th>Data</th>
            <th>Prazo</th>
            <th>Status</th>
            <!-- 🔹 ADICIONADO -->
            <th id="thExcluir" style="display:none;">Excluir</th>
        </tr>
        </thead>
        <tbody id="relatorioBody"></tbody>
    </table>
</div>

</main>

<script src="firebaseConfig.js"></script>

<script>
/* ================= CONTROLES ================= */
function criarControles(){
    const bar = document.createElement('div');
    bar.className = 'controls-bar';

    const statusFilter = document.createElement('select');
    statusFilter.id = 'statusFilter';
    statusFilter.innerHTML = `
        <option value="todos">Todos</option>
        <option value="em aberto">Em aberto</option>
        <option value="resolvido">Resolvidos</option>
    `;
    statusFilter.addEventListener('change', carregarRelatorio);

    bar.appendChild(statusFilter);
    document.getElementById('controlsHolder').appendChild(bar);
}

/* ================= RELATÓRIO ================= */
async function carregarRelatorio(){
    const tbody = document.getElementById('relatorioBody');
    tbody.innerHTML = '';

    const statusFiltro = document.getElementById('statusFilter').value;

    const snap = await db.collection('emprestimos').orderBy('timestamp','desc').get();

    snap.forEach(doc=>{
        const d = doc.data();

        if(statusFiltro !== 'todos' && d.status !== statusFiltro) return;

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${d.nomeMotorista||''}</td>
            <td>${d.matriculaMotorista||''}</td>
            <td>${d.tipoCartao||''}</td>
            <td>${d.numBordoDigicon||'-'}</td>
            <td>${d.numBordoProdata||'-'}</td>
            <td>${d.numMeiaViagem||'-'}</td>
            <td>${d.motivo||''}</td>
            <td>${d.matriculaEmpresto||''}</td>
            <td>${d.dataRetirada||''}</td>
            <td>${d.prazoDevolucao||'-'}</td>
            <td>
                <button class="statusBtn"
                    style="background:${d.status==='em aberto'?'#ff5555':'#55ff55'}">
                    ${d.status}
                </button>
            </td>
        `;

        /* 🔹 BOTÃO EXCLUIR (ADMIN) */
        if(window.isAdmin === true){
            document.getElementById('thExcluir').style.display = '';
            const td = document.createElement('td');
            const btn = document.createElement('button');
            btn.className = 'deleteBtn';
            btn.textContent = 'Excluir';
            btn.onclick = async ()=>{
                if(confirm('Deseja excluir este empréstimo?')){
                    await db.collection('emprestimos').doc(doc.id).delete();
                    carregarRelatorio();
                }
            };
            td.appendChild(btn);
            tr.appendChild(td);
        }

        tbody.appendChild(tr);
    });
}

/* ================= INIT ================= */
criarControles();
carregarRelatorio();
atualizarEstoque();
</script>

<footer class="footer">Relatório atualizado em tempo real</footer>
</body>
</html>
