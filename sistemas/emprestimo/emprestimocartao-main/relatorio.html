<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório de Cartões</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f4f4;
            padding: 20px;
        }

        .filtros {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .filtros label {
            font-size: 14px;
            font-weight: bold;
        }

        .filtros select, .filtros input {
            padding: 6px;
            font-size: 14px;
        }

        .indice-box {
            padding: 6px 10px;
            background: #ddd;
            cursor: pointer;
            border-radius: 6px;
            user-select: none;
        }

        .indice-box.ativo {
            background: #4CAF50;
            color: white;
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            margin-bottom: 80px; /* espaço extra no final */
        }

        th, td {
            padding: 10px;
            border: 1px solid #ccc;
            font-size: 14px;
            text-align: center;
        }

        th {
            background: #eee;
        }
    </style>
</head>
<body>

    <h2>Relatório de Retiradas</h2>

    <!-- 🔥 FILTROS -->
    <div class="filtros">

        <!-- Filtro por Tipo -->
        <div>
            <label>Tipo:</label><br>
            <select id="filtroTipo">
                <option value="">Todos</option>
                <option value="DIGICON">DIGICON</option>
                <option value="PRODATA">PRODATA</option>
                <option value="MEIA">MEIA</option>
            </select>
        </div>

        <!-- Filtro por Número do Cartão -->
        <div>
            <label>Número do Cartão:</label><br>
            <input type="number" id="filtroNumero" placeholder="ex: 3">
        </div>

        <!-- 🔥 NOVO – Filtro por MATRÍCULA -->
        <div>
            <label>Matrícula:</label><br>
            <input type="number" id="filtroMatricula" placeholder="ex: 9123">
        </div>

        <!-- 🔥 NOVO – Índice como BOTÃO -->
        <div>
            <label>Quantidade Retiradas:</label><br>

            <div style="display:flex; gap:8px;">
                <div class="indice-box ativo" data-indice="1">1+</div>
                <div class="indice-box" data-indice="2">2+</div>
                <div class="indice-box" data-indice="3">3+</div>
                <div class="indice-box" data-indice="4">4+</div>
            </div>
        </div>

    </div>

    <!-- Tabela -->
    <table id="tabelaRegistros">
        <thead>
            <tr>
                <th>Motorista</th>
                <th>Matrícula</th>
                <th>Tipo</th>
                <th>Número</th>
                <th>Data</th>
                <th>Quantidade Retiradas</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // CONFIG FIREBASE (use o seu)
        const firebaseConfig = {
            apiKey: "...",
            authDomain: "...",
            projectId: "...",
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Estado do índice
        let indiceMinimo = 1;

        document.querySelectorAll(".indice-box").forEach(btn => {
            btn.addEventListener("click", () => {
                document.querySelectorAll(".indice-box").forEach(b => b.classList.remove("ativo"));
                btn.classList.add("ativo");
                indiceMinimo = Number(btn.dataset.indice);
                carregarRegistros();
            });
        });

        // Carregar registros do Firestore
        let todosRegistros = [];

        async function carregarRegistros() {
            const tabela = document.querySelector("#tabelaRegistros tbody");
            tabela.innerHTML = "<tr><td colspan='6'>Carregando...</td></tr>";

            const filtroTipo = document.getElementById("filtroTipo").value;
            const filtroNumero = document.getElementById("filtroNumero").value.trim();
            const filtroMatricula = document.getElementById("filtroMatricula").value.trim();

            let dadosFiltrados = [...todosRegistros];

            // 🌐 FILTRO TIPO
            if (filtroTipo !== "") {
                dadosFiltrados = dadosFiltrados.filter(r => r.tipoCartao === filtroTipo);
            }

            // 🌐 FILTRO NÚMERO
            if (filtroNumero !== "") {
                dadosFiltrados = dadosFiltrados.filter(r => 
                    r.num === filtroNumero
                );
            }

            // 🌐 FILTRO MATRÍCULA
            if (filtroMatricula !== "") {
                dadosFiltrados = dadosFiltrados.filter(r =>
                    r.matriculaMotorista.includes(filtroMatricula)
                );
            }

            // 🌐 AGRUPAR por motorista para contar quantidade de retiradas
            const contagem = {};
            dadosFiltrados.forEach(r => {
                if (!contagem[r.matriculaMotorista]) contagem[r.matriculaMotorista] = 0;
                contagem[r.matriculaMotorista]++;
            });

            // 🌐 APLICAR INDICE (ex: 2+ → só quem retirou 2 ou mais)
            dadosFiltrados = dadosFiltrados.filter(r =>
                contagem[r.matriculaMotorista] >= indiceMinimo
            );

            // 🌐 EXIBIR TABELA
            tabela.innerHTML = "";

            dadosFiltrados.forEach(r => {
                tabela.innerHTML += `
                    <tr>
                        <td>${r.nomeMotorista}</td>
                        <td>${r.matriculaMotorista}</td>
                        <td>${r.tipoCartao}</td>
                        <td>${r.num}</td>
                        <td>${r.dataRetirada}</td>
                        <td>${contagem[r.matriculaMotorista]}</td>
                    </tr>
                `;
            });

            if (dadosFiltrados.length === 0) {
                tabela.innerHTML = "<tr><td colspan='6'>Nenhum registro encontrado.</td></tr>";
            }
        }

        // Carregar Firestore uma vez
        async function iniciar() {
            const snap = await db.collection("emprestimos").get();

            todosRegistros = snap.docs.map(doc => {
                const d = doc.data();
                return {
                    nomeMotorista: d.nomeMotorista || "",
                    matriculaMotorista: d.matriculaMotorista || "",
                    tipoCartao: d.tipoCartao || "",
                    num: d.numBordoDigicon || d.numBordoProdata || d.numMeiaViagem || "",
                    dataRetirada: d.dataRetirada || ""
                };
            });

            carregarRegistros();
        }

        iniciar();

        // Filtros ativados automaticamente
        document.querySelectorAll("#filtroTipo, #filtroNumero, #filtroMatricula")
            .forEach(el => el.addEventListener("input", carregarRegistros));
    </script>

</body>
</html>
